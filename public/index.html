<!DOCTYPE html>

<html>

<head>

    <title>Handlebars Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"
        integrity="sha512-RNLkV3d+aLtfcpEyFG8jRbnWHxUqVZozacROI4J2F1sTaDqo1dPQYs01OMi1t1w9Y2FdbSCDSQ2ZVdAC8bzgAg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" type="text/css" href="style.css">

</head>

<body>

    <div id="root" class="restaurant-container"></div>

    <script id="restaurant-template" type="text/x-handlebars-template">
        {{#each restaurants}}
        <div class="restaurant-box" id="{{this.id}}" onclick=restaurantClicked(this.id)>
            <div class="item-text">
                <h1>{{name}}</h1>
                <ul id="{{this.id}}-menus">
                    CLICK FOR MORE INFORMATION
                </ul>
            </div>
            
            <img src={{this.image}} width=200 height=200>
        </div>
        {{/each}}
    </script>

    <script id="menu-template" type="text/x-handlebars-template">
        {{#each menus}}
        <li class="menu-box" id="{{this.id}}" onclick="menuClicked(this.id); event.cancelBubble=true;">
            {{title}}

            <ul id="{{this.id}}-items">
                CLICK FOR DETAILED MENU
            </ul>
        </li>
        {{/each}}
    </script>

    <script>
        const restaurant_template_source = document.getElementById("restaurant-template").innerHTML;
        const restaurant_template = Handlebars.compile(restaurant_template_source);

        fetch("/restaurants").then((response) => {
            response.json().then(contexts => {
                const html = restaurant_template({ restaurants: contexts });
                document.getElementById("root").innerHTML = html;
            });
        });

        let menus = [];
        async function restaurantClicked(clickedId) {

            if (document.getElementById(`${clickedId}-menus`).innerText === "CLICK FOR MORE INFORMATION") {
                // implement extremely basic caching
                if (menus.length === 0) {
                    const response = await fetch("/menus");
                    menus = await response.json();
                }

                const relevantMenus = menus.filter((value) => { return value.restaurantId.toString() === clickedId });

                const menu_template_source = document.getElementById("menu-template").innerHTML;
                const menu_template = Handlebars.compile(menu_template_source);

                const html = menu_template({ menus: relevantMenus });

                document.getElementById(`${clickedId}-menus`).innerHTML = html;
            } else {
                document.getElementById(`${clickedId}-menus`).innerText = "CLICK FOR MORE INFORMATION"
            }
        }

        async function menuClicked(clickedId) {

            console.log(document.getElementById(`${clickedId}-items`).innerText)

            if (document.getElementById(`${clickedId}-items`).innerText === "CLICK FOR DETAILED MENU") {
                const response = await fetch(`/menus/${clickedId}`);
                const items = (await response.json()).items;

                let html = "";

                for (let i = 0; i < items.length; i++) {
                    html += `<li>${items[i].name} - Â£${items[i].price}</li>`;
                }
                document.getElementById(`${clickedId}-items`).innerHTML = html;
            } else {
                document.getElementById(`${clickedId}-items`).innerText = "CLICK FOR DETAILED MENU";
            }
        }

    </script>

</body>

</html>